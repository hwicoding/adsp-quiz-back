name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -p ${{ secrets.SERVER_PORT || '22' }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || true
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
        run: |
          ssh -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=~/.ssh/known_hosts -p ${SERVER_PORT} ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            set -e
            
            PROJECT_DIR="/opt/adsp-quiz-backend"
            ENV_FILE="${PROJECT_DIR}/env/.env"
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ğŸ“¦ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
              sudo mkdir -p "$PROJECT_DIR"
              sudo chown -R ${USER}:${USER} "$PROJECT_DIR" || true
            fi
            
            cd "$PROJECT_DIR" || exit 1
            
            # Git ì €ì¥ì†Œ ì´ˆê¸°í™” ë˜ëŠ” ë™ê¸°í™”
            if [ ! -d ".git" ]; then
              echo "ğŸ“¦ Git ì €ì¥ì†Œ ì´ˆê¸°í™” ì¤‘..."
              git init || true
              git remote add origin https://github.com/EHWIYA/adsp-quiz-back.git || git remote set-url origin https://github.com/EHWIYA/adsp-quiz-back.git || true
            fi
            
            # ìµœì‹  ì½”ë“œ ë™ê¸°í™” (ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì „ í•„ìˆ˜)
            echo "ğŸ“¦ [0/8] Git ì½”ë“œ ë™ê¸°í™” ì‹œì‘..."
            git fetch origin || true
            git reset --hard origin/main || true
            git clean -fd --exclude='data/postgres' || true
            echo "âœ… ì½”ë“œ ë™ê¸°í™” ì™„ë£Œ"
            
            # í™˜ê²½ë³€ìˆ˜ ì„¤ì • (GitHub Secretsì—ì„œ ì£¼ì…)
            export DATABASE_URL="${{ secrets.DATABASE_URL }}"
            export DB_USER="${{ secrets.DB_USER }}"
            export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            export GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY || '' }}"
            export SECRET_KEY="${{ secrets.SECRET_KEY }}"
            export ALLOWED_ORIGINS="${{ secrets.ALLOWED_ORIGINS }}"
            export ENV_FILE PROJECT_DIR
            
            # GitHub Actions ì „ìš© ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            if [ -f "${PROJECT_DIR}/scripts/deploy/github-actions-deploy.sh" ]; then
              chmod +x "${PROJECT_DIR}/scripts/deploy/github-actions-deploy.sh"
              "${PROJECT_DIR}/scripts/deploy/github-actions-deploy.sh" || exit 1
            else
              echo "âŒ GitHub Actions ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
              echo "ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ: ${PROJECT_DIR}/scripts/deploy/github-actions-deploy.sh"
              ls -la "${PROJECT_DIR}/scripts/deploy/" 2>/dev/null || echo "scripts/deploy ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
              exit 1
            fi
          ENDSSH

      - name: Deployment status
        if: success()
        run: |
          echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ì• í”Œë¦¬ì¼€ì´ì…˜ URL: https://adsp-api.livbee.co.kr"

      - name: Deployment failed
        if: failure()
        run: |
          echo "âŒ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
