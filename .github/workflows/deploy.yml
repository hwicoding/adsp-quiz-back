name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 수동 실행 가능

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -p ${{ secrets.SERVER_PORT || '22' }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || true
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
        run: |
          ssh -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=~/.ssh/known_hosts -p ${SERVER_PORT} ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            set -e
            
            PROJECT_DIR="/opt/adsp-quiz-backend"
            ENV_FILE="${PROJECT_DIR}/env/.env"
            
            echo "=== GitHub Actions 배포 시작 ==="
            cd "$PROJECT_DIR"
            
            # 환경변수 설정
            export DATABASE_URL="${{ secrets.DATABASE_URL }}"
            export DB_USER="${{ secrets.DB_USER }}"
            export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            export GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY || '' }}"
            export SECRET_KEY="${{ secrets.SECRET_KEY }}"
            export ALLOWED_ORIGINS="${{ secrets.ALLOWED_ORIGINS }}"
            export ENV_FILE PROJECT_DIR
            
            # 1. Git 코드 동기화
            if [ -f "${PROJECT_DIR}/scripts/utils/git-sync.sh" ]; then
              chmod +x "${PROJECT_DIR}/scripts/utils/git-sync.sh"
              "${PROJECT_DIR}/scripts/utils/git-sync.sh"
            else
              git fetch origin && git reset --hard origin/main && git clean -fd --exclude='data/postgres' || true
            fi
            
            # 2. 환경변수 파일 확인
            if [ -f "${PROJECT_DIR}/scripts/env/ensure-env-file.sh" ]; then
              chmod +x "${PROJECT_DIR}/scripts/env/ensure-env-file.sh"
              "${PROJECT_DIR}/scripts/env/ensure-env-file.sh"
            else
              [ ! -f "$ENV_FILE" ] && [ -f "${PROJECT_DIR}/env/.env.template" ] && cp "${PROJECT_DIR}/env/.env.template" "$ENV_FILE" && chmod 600 "$ENV_FILE" || true
            fi
            
            # 3. BOM 제거
            if [ -f "${PROJECT_DIR}/scripts/utils/remove-bom.sh" ]; then
              chmod +x "${PROJECT_DIR}/scripts/utils/remove-bom.sh"
              "${PROJECT_DIR}/scripts/utils/remove-bom.sh" "$ENV_FILE"
            fi
            
            # 4. 환경변수 업데이트
            if [ -f "${PROJECT_DIR}/scripts/env/update-env.sh" ]; then
              chmod +x "${PROJECT_DIR}/scripts/env/update-env.sh"
              "${PROJECT_DIR}/scripts/env/update-env.sh"
            fi
            
            # 5. 환경변수 검증
            if [ -f "${PROJECT_DIR}/scripts/env/verify-env.sh" ]; then
              chmod +x "${PROJECT_DIR}/scripts/env/verify-env.sh"
              "${PROJECT_DIR}/scripts/env/verify-env.sh"
            fi
            
            # 6. 데이터베이스 비밀번호 검증
            if [ -f "${PROJECT_DIR}/scripts/db/verify-db-password.sh" ]; then
              chmod +x "${PROJECT_DIR}/scripts/db/verify-db-password.sh"
              "${PROJECT_DIR}/scripts/db/verify-db-password.sh" || exit 1
            fi
            
            # 7. 배포 스크립트 실행
            if [ -f "${PROJECT_DIR}/scripts/deploy/deploy.sh" ]; then
              chmod +x "${PROJECT_DIR}/scripts/deploy/deploy.sh"
              "${PROJECT_DIR}/scripts/deploy/deploy.sh" || exit 1
            else
              docker-compose --env-file "$ENV_FILE" down || true
              docker-compose --env-file "$ENV_FILE" build --no-cache
              docker-compose --env-file "$ENV_FILE" up -d
              sleep 10
              docker-compose --env-file "$ENV_FILE" exec -T app alembic upgrade head || exit 1
            fi
            
            # 8. 헬스체크
            if [ -f "${PROJECT_DIR}/scripts/utils/health-check.sh" ]; then
              chmod +x "${PROJECT_DIR}/scripts/utils/health-check.sh"
              "${PROJECT_DIR}/scripts/utils/health-check.sh" "https://adsp-api.livbee.co.kr/health" 5 10 "$ENV_FILE" || exit 1
            fi
            
            echo "=== 배포 완료 ==="
          ENDSSH

      - name: Deployment status
        if: success()
        run: |
          echo "✅ 배포가 성공적으로 완료되었습니다!"
          echo "애플리케이션 URL: https://adsp-api.livbee.co.kr"

      - name: Deployment failed
        if: failure()
        run: |
          echo "❌ 배포가 실패했습니다. 서버 로그를 확인하세요."
