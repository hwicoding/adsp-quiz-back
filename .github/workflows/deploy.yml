name: Deploy to Production
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY || '' }}
          GEMINI_MAX_CONCURRENT: ${{ secrets.GEMINI_MAX_CONCURRENT || '2' }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
        run: |
          chmod +x ./scripts/deploy/ssh/setup-ssh.sh ./scripts/deploy/ssh/remote-deploy.sh
          ./scripts/deploy/ssh/setup-ssh.sh
          ssh -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=~/.ssh/known_hosts -p ${SERVER_PORT} ${SERVER_USER}@${SERVER_HOST} 'bash -s' < ./scripts/deploy/ssh/remote-deploy.sh
      - name: Deployment status
        if: success()
        run: |
          echo '✅ 배포 완료: https://adsp-api.livbee.co.kr'
      - name: Deployment failed
        if: failure()
        run: |
          echo '❌ 배포 실패: 서버 로그 확인 필요'
