name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 수동 실행 가능

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -p ${{ secrets.SERVER_PORT || '22' }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || true
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
        run: |
          ssh -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=~/.ssh/known_hosts -p ${SERVER_PORT} ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            set -e
            
            PROJECT_DIR="/opt/adsp-quiz-backend"
            ENV_FILE="${PROJECT_DIR}/env/.env"
            
            cd "$PROJECT_DIR" || exit 1
            
            # 환경변수 설정 (GitHub Secrets에서 주입)
            export DATABASE_URL="${{ secrets.DATABASE_URL }}"
            export DB_USER="${{ secrets.DB_USER }}"
            export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            export GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY || '' }}"
            export SECRET_KEY="${{ secrets.SECRET_KEY }}"
            export ALLOWED_ORIGINS="${{ secrets.ALLOWED_ORIGINS }}"
            export ENV_FILE PROJECT_DIR
            
            # GitHub Actions 전용 배포 스크립트 실행
            if [ -f "${PROJECT_DIR}/scripts/deploy/github-actions-deploy.sh" ]; then
              chmod +x "${PROJECT_DIR}/scripts/deploy/github-actions-deploy.sh"
              "${PROJECT_DIR}/scripts/deploy/github-actions-deploy.sh" || exit 1
            else
              echo "❌ GitHub Actions 배포 스크립트를 찾을 수 없습니다."
              exit 1
            fi
          ENDSSH

      - name: Deployment status
        if: success()
        run: |
          echo "✅ 배포가 성공적으로 완료되었습니다!"
          echo "애플리케이션 URL: https://adsp-api.livbee.co.kr"

      - name: Deployment failed
        if: failure()
        run: |
          echo "❌ 배포가 실패했습니다. 서버 로그를 확인하세요."
